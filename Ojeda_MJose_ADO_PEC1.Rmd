---
title: "PAC 1 - ANÁLISIS DE DATOS ÓMICOS (UOC)"
subtitle: "Proceso de análisis de microarrays"
author: "María José Ojeda-Montes"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
bibliography: biblio.bib
csl: elsevier-vancouver.csl
link-citations: yes
output:
  rmdformats::readthedown:
    highlight: "pygments"
    gallery: true
    fig_width: 10
    fig_height: 8
    fig_caption: yes
    use_bookdown: true
    toc_depth: 3
  prettydoc::html_pretty:
    highlight: null
    number_sections: false
    theme: hpstr
    toc: yes
    toc_depth: 3
    fig_caption: yes
  pdf_document: 
    fig_caption: yes
    toc: true
    toc_depth: 3
  html_document:
    fig_caption: yes
    toc: true
    number_sections: False
    toc_float:
      collapsed: true
params:
  target_file: targets.csv
  normalized_file: normalized.Data.Rda
  GSE: GSE85167
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include=FALSE}
# Load packages
library(knitr)
library(oligo)
library(Biobase)
library(arrayQualityMetrics)
library(ggplot2)
library(ggrepel)
library(affyio)
library(pvca)
library(genefilter)
library(limma)
library(gplots)
library(clusterProfiler)
library(DOSE)
library(enrichplot)
```

# ANÁLISIS DE MICROARRAYS

```{r directories, include=FALSE}
workDir <- getwd()
setwd(workDir)
dir.create("data")
dir.create("results")
dir.create("figures")
dataDir <- file.path(workDir, "data")
resultsDir <- file.path(workDir, "results")
figuresDir <- file.path(workDir, "figures")
```

## Estudio de microarrays

+ _Título del estudio_: **Identification of a nutrient-sensing transcriptional network in monocytes by using inbred rat models on a cafeteria diet (2016)** [@PMID-27483348]

+ _Autores_: Neus Martínez-Micaelo, Noemí González-Abuín, Ximena Terra, Ana Ardévol, Monterrat Pinent, Enrico Petretto, Jacques Behmoaras y Mayte Blay

+ _Enlace al artículo_: [PMID-27483348](https://www.ncbi.nlm.nih.gov/pubmed/?term=27483348)

+ _Enlace a los datos_: [GSE85167](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE85167)

+ _Enlace a github_: [Repositorio](https://github.com/MJoseom/ADO_GSE85167)

El objetivo de la práctica es reproducir los resultados obtenidos por el propio artículo [@PMID-27483348] siguiendo el protocolo ofrecido en el material de la asignatura de Análisis de Datos Ómicos [@microarrays], entendiendo el por qué de cada uno de los pasos que se realizan.

Por lo tanto, el objetivo principal de este estudio es **analizar el efecto de la dieta (STD vs cafetería) en la expresión genética de cada tipo de rata (lewis o wistar kyoto).** También se pretende **analizar si la dieta afecta en la expresión de monocitos de forma distinta en cada cepa**. 

## Identificación de los grupos

Se trata de una muestra de 20 animales divididos en 4 grupos cada uno de ellos con 5 réplicas por grupo. Para cada grupo se considera la combinación de dos factores con dos niveles cada uno de ellos: 

+ dieta (niveles: STD y CAF)

+ cepa de rata (niveles: LEW y WKY)

```{r, include=TRUE, echo=FALSE}
targets <- read.csv2(file.path(dataDir, params$target_file), header = TRUE, sep = ";") 
kable(targets, caption = 'Identificación de los grupos para cada archivo CEL', digits = 5, row.names = FALSE)
```

+ **Archivos CEL**

```{r, include=TRUE, results='hide', echo=FALSE, message=FALSE, warning=FALSE}
celFiles <- list.celfiles(dataDir, full.names = TRUE)
my.targets <-read.AnnotatedDataFrame(file.path(dataDir,params$target_file), 
                                     header = TRUE, row.names = 1, sep=";") 
rawData <- read.celfiles(celFiles, phenoData = my.targets)
my.targets@data$X.ShortName. -> rownames(pData(rawData))
colnames(rawData) <- rownames(pData(rawData)) 
```

```{r, include=TRUE, echo=FALSE}
head(rawData)
#Dimensiones de los datos
dim_genes <- dim(exprs(rawData))
```

Se trata del archivo de datos con código `r params$GSE` que tiene `r dim_genes[1]` genes y `r dim_genes[2]` muestras. 

## Control de calidad de los datos crudos

```{r, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
arrayQualityMetrics(rawData, outdir = file.path(resultsDir, "QualityMetricsRawData"))
```

```{r, fig.align="center", fig.cap="Detección de outliers de los datos sin procesar (extraído del archivo 'index.html' producido por el paquete 'arrayQualityMetrics')", echo=FALSE}
include_graphics(file.path(figuresDir, "Figure_1.png"), dpi = 150)
```

Con el paquete `ArrayQualityMetrics` de Bioconductor analizamos la presencia de _outliers_ mediante diferentes aproximaciones (ver Figura 1). Como resultado obtenemos 3 muestras que superan el _threshold_ para los MA plots y una muestra que supera el _threshold_ de intensidad de los datos representado en el _boxplot_. Dado que estas muestras solamente presentan un asterisco, las mantedremos sin considerarlas un problema potencial. Sin embargo, la muestra `WKY.STD.5` debería ser revisada tras la normalización y probablemente eliminada para mejorar la calidad de los datos dado que presenta asterisco para las tres metodologías analizadas. 

```{r, include= FALSE, echo=FALSE}
plotPCA3 <- function (datos, labels, factor, title, scale,colores, size = 1.5, glineas = 0.25) {
   #PCA
   data <- prcomp(t(datos),scale=scale)
   # plot adjustments
   dataDf <- data.frame(data$x)
   Group <- factor
   loads <- round(data$sdev^2/sum(data$sdev^2)*100,1)
   # main plot
   p1 <- ggplot(dataDf,aes(x=PC1, y=PC2)) +
     theme_classic() +
     geom_hline(yintercept = 0, color = "gray70") +
     geom_vline(xintercept = 0, color = "gray70") +
     geom_point(aes(color = Group), alpha = 0.55, size = 3) +
     coord_cartesian(xlim = c(min(data$x[,1])-5,max(data$x[,1])+5)) +
     scale_fill_discrete(name = "Group")
   # avoiding labels superposition
   p1 + geom_text_repel(aes(y = PC2 + 0.25, label = labels),segment.size = 0.25, size = size) + 
     labs(x = c(paste("PC1",loads[1],"%")),y=c(paste("PC2",loads[2],"%"))) +  
     ggtitle(paste("Principal Component Analysis for: ",title,sep=" "))+ 
     theme(plot.title = element_text(hjust = 0.5)) +
     scale_color_manual(values=colores)
   }
```

```{r, fig.width = 10, fig.asp = .4, fig.align="center", fig.cap="Visualización de las dos primeras componentes principales del PCA para los datos sin procesar", echo=FALSE}
plotPCA3(exprs(rawData), labels = targets$ShortName, factor = targets$Group, 
         title="Raw data", scale = FALSE, size = 3, 
         colores = c("red", "blue", "green", "yellow"))
```

En el gráfico de la Figura 2 se han representado las dos primeras componentes del PCA (Principal Component Analysis) que explicarían el 46% total de la variabilidad de las muestras. Observamos que las réplicas se encuentran agrupadas por los grupos determinados por la cepa de rata y la dieta administrada, con la excepción del grupo `WKY.STD` entre las cuales recordemos se encuentra el potencial _outlier_, situado arriba-derecha de la gráfica. La variabilidad de la primera componente tiene una contribución muy alta de la cepa WKY, que como podemos observar se encuentran todas las muestras a la derecha de la gráfica, mientras que la cepa LEW la encontramos a la izquierda. Respecto a la contribución de la segunda componente, la contribución no está tan dividida, pero observamos que hay una tendencia a que las muestras de la dieta STD se encuentran con valores positivos más elevados que los correspondientes a la dieta CAF que tienden a encontrarse en el inferior de la gráfica. 

```{r, fig.width = 10, fig.asp = .4, fig.align="center", fig.cap="Diagrama de caja para intensidades de matrices de los datos sin procesar", echo=FALSE}
boxplot(rawData, cex.axis=0.8, las=2,  which="all", 
        col = c(rep("red", 5), rep("blue", 5), rep("green", 5), rep("yellow", 5)),
        main="Distribution of intensity values: Raw data")
```

En el diagrama de cajas se representa la distribución de la intesidad de los arrays (ver Figura 3). Podemos observar que la media es bastante regular entre las réplicas y entre los grupos. Sin embargo, observamos una mayor variabilidad en el caso de las réplicas pertenecientes a `WKY.STD` entre los cuales se encuentra el potencial _outlier_.

```{r, fig.width = 10, fig.asp = .4, fig.align="center", fig.cap="Histograma de la señal de los arrays correspondientes a los datos sin procesar", echo=FALSE}
hist(rawData, cex.axis=0.5, las=2, which="all",
     col = c(rep("red", 5), rep("blue", 5), rep("green", 5), rep("yellow", 5)),
     main="Distribution Signals")
legend(13,0.35, legend=unique(targets$Group), y.intersp=0.9, x.intersp=1.1, cex=0.9,col =c("red", "blue", "green", "yellow"), lwd = 3)
```

Observamos que la señal de todos los arrays (ver Figura 4) sigue una distribución muy parecida con los datos crudos, no hay aparentemente ninguna alteración o diferencia. 

## Normalización

Antes de inicar el análisis, realizamos la normalización de los datos para poder compararlos entre ellos y así reducir la variabilidad de las muestras no debidas a razones biológicas. Con la normalización, observaremos si reducimos el _outlier_ que nos marcaba el apartado anterior o bien si debemos eliminarlo. Realizamos la normalización con la función `rma` del paquete `oligo`.

```{r, include=TRUE, echo=FALSE}
eset_rma <- rma(rawData)
#Dimensiones de los datos tras la normalización
dim_norm <- dim(exprs(eset_rma))
```

Tras la normalización del archivo de datos con código `r params$GSE`, se observan `r dim_norm[1]` genes y `r dim_norm[2]` muestras. Vemos que se ha reducido bastante el número de genes.


## Control de calidad de los datos normalizados

```{r, include= FALSE, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
arrayQualityMetrics(eset_rma, outdir = file.path(resultsDir, "QualityMetricsNormalized"), force = TRUE)
```

```{r, fig.align="center", fig.cap="Detección de outliers de los datos normalizados (extraído del archivo 'index.html' producido por el paquete 'arrayQualityMetrics')", echo=FALSE}
include_graphics(file.path(figuresDir, "Figure_2.png"), dpi = 150)
```

Gracias a la normalización de los datos observamos que la muestra `WKY.STD.5` que era un potencial _outlier_ se ha corregido (ver Figura 5). Aún así, se mantienen un asterisco en dos muestras de este mismo grupo que como habíamos visto presentaba mayores variaciones. 

```{r, fig.width = 10, fig.asp = .4, fig.align="center", fig.cap="Visualización de las dos primeras componentes principales del PCA para los datos normalizados", echo=FALSE}
plotPCA3(exprs(eset_rma), labels = targets$ShortName, factor = targets$Group, 
         title="Normalized data", scale = FALSE, size = 3, 
         colores = c("red", "blue", "green", "yellow"))
```

En el diagrama de dispersión de las dos primeras componentes principales realizado usando esta vez los datos normalizados (ver Figura 6), es importante destacar que ha aumentado ligeramente (_i.e._, 49.7%) la variabilidad explicada por ambas componentes respecto al PCA realizado con los datos crudos (ver Figura 2), aunque la proporción ha variado notablemente, siendo la PC1 la que contribuye en su mayor parte. De la misma forma que en la Figura 2, las muestras quedan separadas en la PC1 de acuerdo al factor cepa de rata, situando el nivel WKY a la derecha y LEW a la izquierda. Sin embargo, resulta difícil en esta ocasión establecer una distribución diferenciada de las muestras de acuerdo al factor de la dieta, lo que provoca que los grupos de dieta no se encuentren agrupados como en la Figura 2. 
  
```{r, fig.width = 10, fig.asp = .4, fig.align="center", fig.cap="Diagrama de caja para intensidades de matrices de los datos normalizados", echo=FALSE}
boxplot(eset_rma, cex.axis=0.8, las=2,  which="all", 
        col = c(rep("red", 5), rep("blue", 5), rep("green", 5), rep("yellow", 5)),
        main="Distribution of intensity values: Normalized data")
```

El diagrama de cajas (ver Figura 7) muestra la distribución de las intesidades normalizadas de las muestras. Nuevamente, dado que todas las cajas presentan un aspecto homogéneo, podemos determinar que la normalización ha permitido corregir las pequeñas variaciones que existían, especialmente en el grupo `WKY.STD`.

## Filtraje no específico

Con el fin de analizar pequeñas variaciones en la expresión génica por causas no biológicas (_i.e._, investigador-técnico, fecha del procesamiento, reactivos), realizamos un _Principal variation component analysis_ (PVCA). 

```{r, include= FALSE, echo=TRUE, warning=FALSE}
fechas <- get.celfile.dates(celFiles)
```

En primer lugar, comprobamos que todos los microarrays se realizaron en la misma fecha: `r unique(fechas)`

+ **_Principal variation component analysis_ (PVCA)**

```{r, include= FALSE, echo=FALSE, warning=FALSE}
pData(eset_rma) <- targets
#select the threshold
pct_threshold <- 0.6
#select the factors to analyze
batch.factors <- c("Cepa", "Dieta")
#run the analysis
pvcaObj <- pvcaBatchAssess(eset_rma, batch.factors, pct_threshold)
```

```{r, fig.width = 10, fig.asp = .4, fig.align="center", echo=FALSE, fig.cap="Importancia relativa de los diferentes factores (Cepa, Dieta e interacción) que afectan la expresión génica"}
bp <- barplot(pvcaObj$dat, xlab = "Effects",
              ylab = "Weighted average proportion variance",
              ylim= c(0,1.1), col = c("mediumorchid"), las=2,
              main="PVCA estimation")
axis(1, at = bp, labels = pvcaObj$label, cex.axis = 0.75, las=2)
values = pvcaObj$dat
new_values = round(values , 3)
text(bp,pvcaObj$dat,labels = new_values, pos=3, cex = 0.7)
```

El histograma (ver Figura 8) muestra una barra por cada fuente de variación del análisis (_i.e._, cepa, dieta e interacción). Observamos que la principal fuente de variación es la condición de la cepa de rata que contribuye con un 56.6% a la variación de los datos causada por el factor lote, como se vio en las anteriores gráficas de PCA (ver Figuras 2 y 6). La dieta en cambio tiene una contribución mínima. 

## Identificación de genes diferencialmente expresados

```{r, fig.width = 10, fig.asp = .4, fig.align="center", echo=FALSE, fig.cap="Desviación estándard para todos los genes de todas las muestras ordenados de menor a mayor"}
sds <- apply (exprs(eset_rma), 1, sd)
sdsO<- sort(sds)
plot(1:length(sdsO), sdsO, main="Distribution of variability for all genes",
    sub="Vertical lines represent 90% and 95% percentiles",
    xlab="Gene index (from least to most variable)", ylab="Standard deviation")
abline(v=length(sds)*c(0.9,0.95), col="red")
```

Se considera un gen diferencialmente expresado si hay una cierta diferencia en la varianza entre los grupos de estudio. En el gráfico (ver Figura 9) se traza la variabilidad general de todos los genes, con el fin de tener una idea del porcentaje de genes que presentan variabilidad no atribuible a una variación aleatoria. Por ello, en este gráfico se representa la desviación estándard de todos los genes ordenada de forma ascendente. Los genes más variables son los que se encuentran con una desviación estándar superior al 90-95%, es decir, todos aquellos genes a la derecha de las líneas verticales rojas, en este caso, corresponde a algo menos de 5000 genes. 

```{r, include= FALSE, echo=TRUE, results='hide', message=FALSE}
library(pd.ragene.1.0.st.v1)
library(ragene10sttranscriptcluster.db)
annotation(eset_rma) <- "ragene10sttranscriptcluster.db"
filtered <- nsFilter(eset_rma, 
                     require.entrez = TRUE, remove.dupEntrez = TRUE,
                     var.filter=TRUE, var.func=IQR, var.cutoff=0.75, 
                     filterByQuantile=TRUE, feature.exclude = "^AFFX")
```

```{r, include=TRUE, echo=TRUE}
print(filtered$filter.log)
eset_filtered <-filtered$eset
eset_filtered
```

En consecuencia, resulta importante filtrar aquellos genes cuya variabilidad en la expresión génica es atribuible a la aleatoriedad y no como resultado del diseño experimental. Para ello, descargamos la base de datos de anotaciones en función del tipo de microarray empleado. Por lo tanto, dado que se ha empleado el microarray _Affymetrix Rat Gene 1.0 ST Array_, se ha buscado en la web de [Bioconductor](http://bioconductor.org/packages/release/data/annotation/html/ragene10sttranscriptcluster.db.html) la base de datos correspondiente, `ragene10sttranscriptcluster.db`, en este caso. A continuación, se han filtrado los genes con la función `nsFilter` y se han obtenido 4464 genes con potencial para ser diferencialmente expresados, eliminando aquellos que presentaban variaciones aleatorias.

```{r, include= FALSE, echo=FALSE, results='hide', message=FALSE}
# Exportación de los datos normalizados
write.csv(exprs(eset_rma), file= file.path(resultsDir, "normalized.Data.csv"))
write.csv(exprs(eset_filtered), file=file.path(resultsDir, "normalized.Filtered.Data.csv"))
save(eset_rma, eset_filtered, file=file.path(resultsDir, "normalized.Data.Rda"))
```

+ **Matriz de diseño**

La matriz de diseño permite mostrar la asignación de cada muestra a un grupo experimental. En este caso tenemos una matriz de 20 filas, una por muestra, y 4 columnas, una por grupo. Cada fila contiene un 1 en la columna del grupo al que pertenece la muestra y un 0 en los demás.

```{r, echo=FALSE}
if (!exists("eset_filtered")) load (file= file.path(resultsDir, params$normalized_file))
```

```{r, include= TRUE, echo=FALSE, message=FALSE}
designMat<- model.matrix(~0+Group, pData(eset_filtered))
colnames(designMat) <- unique(targets$Group)
print(designMat)
```

+ **Matriz de contraste**

En este estudio el objetivo principal es analizar el efecto de la dieta en la expresión génica por cada cepa de rata (_i.e._, WKY.STD vs WKY.CAF -- LEW.STD vs LEW.CAF), así como la interacción entre la dieta y la cepa. Por lo tanto, la matriz de contraste quedaría del siguiente modo:

```{r, include= TRUE, echo=TRUE, message=FALSE, include= TRUE}
cont.matrix <- makeContrasts (STDvsCAF.LEW = LEW.STD - LEW.CAF,
                              STDvsCAF.WKY = WKY.STD - WKY.CAF,
                              INT = (LEW.STD - LEW.CAF) - (WKY.STD - WKY.CAF),
                              levels=designMat)
print(cont.matrix)
```

+ **Estimación del modelo y selección de genes diferenciados**

Realizamos los tests de significancia con el paquete `limma` para seleccionar aquellos genes diferencialmente expresados, definidos en las anteriores comparaciones. Se realiza también el ajuste del p-valor con el método Benjamini and Hochberg con el fin de evitar la aparición de un alto número de falsos positivos debido al alto número de cálculos de contrastes simultáneos en los mismos datos.

```{r, include= TRUE, echo=TRUE, message=FALSE, warning=FALSE}
fit <- lmFit(eset_filtered, designMat)
fit.main <- contrasts.fit(fit, cont.matrix)
fit.main <- eBayes(fit.main)
class(fit.main)
```

```{r,fig.width = 10, fig.asp = 1, fig.align="center", echo=FALSE, fig.cap="Gráfico volcán para las diferentes comparaciones considerando la cepa de rata y la dieta administrada"}
geneSymbols <- select(ragene10sttranscriptcluster.db, rownames(fit.main), c("SYMBOL"))
SYMBOLS<- geneSymbols$SYMBOL
par(mfrow=c(2,2))
volcanoplot(fit.main, coef=1, highlight=5, names=SYMBOLS, 
            main=paste("Differentially expressed genes", colnames(cont.matrix)[1], sep="\n"))
abline(v=c(-1,1),col="red")
volcanoplot(fit.main, coef=2, highlight=5, names=SYMBOLS, 
            main=paste("Differentially expressed genes", colnames(cont.matrix)[2], sep="\n"))
abline(v=c(-1,1),col="red")
volcanoplot(fit.main, coef=3, highlight=5, names=SYMBOLS, 
            main=paste("Differentially expressed genes", colnames(cont.matrix)[3], sep="\n"))
abline(v=c(-1,1),col="red")
par(mfrow=c(1,1))
```

El volcano plot (ver Figura 10) permite visualizar de forma gráfica los genes que presentan expresión diferenciada para cada una de las comparaciones. En estos gráficos se muestra el fold-change, es decir, la escala logarítmica del efecto biológico y si éste es significativo en función del p-valor. Además, se destaca el nombre de los 5 genes más significativos para cada una de las comparaciones. Observamos que los volcano plot son muy equivalentes para la comparación del efecto de la dieta administrada en cada una de las cepas. En cambio, el volcano plot para la interacción, presenta valores muy bajos para el logaritmo del p-valor y muy agrupados entorno a 0 para el fold-change. 

+ **Lista de genes diferencialmente expresados**

Con la función `topTable` del paquete `limma` que permite obtener una lista ordenada según el p-valor del contraste ordenada de forma ascendente. 


  a) LEW.STD vs LEW.CAF: analizar el efecto de la dieta en la expresión génica para la cepa LEW

```{r, include=TRUE, echo=FALSE}
topTab_STDvsCAF.LEW <- topTable (fit.main, number=nrow(fit.main), coef="STDvsCAF.LEW", adjust="fdr") 
topTab_STDvsCAF.LEW <- topTab_STDvsCAF.LEW[order(topTab_STDvsCAF.LEW$adj.P.Val),]
kable(head(topTab_STDvsCAF.LEW,3), caption = 'Genes que modifican su expresión en función de la dieta administrada en la cepa de rata LEW (tabla ordenada según el p-valor ajustado)', digits = 30, row.names = TRUE)
```

  b) WKY.STD vs WKY.CAF: analizar el efecto de la dieta en la expresión génica para la cepa WKY
  
```{r, include=TRUE, echo=FALSE}
topTab_STDvsCAF.WKY <- topTable (fit.main, number=nrow(fit.main), coef="STDvsCAF.WKY", adjust="fdr") 
topTab_STDvsCAF.WKY <- topTab_STDvsCAF.WKY[order(topTab_STDvsCAF.WKY$adj.P.Val),]
kable(head(topTab_STDvsCAF.WKY, 3), caption = 'Genes que modifican su expresión en función de la dieta administrada en la cepa de rata WKY (tabla ordenada según el p-valor ajustado)', digits = 30, row.names = TRUE)
```

  c) INT: interacción entre la dieta administrada y la cepa de rata
  
```{r, include=TRUE, echo=FALSE}
topTab_INT <- topTable (fit.main, number=nrow(fit.main), coef="INT", adjust="fdr") 
topTab_INT <- topTab_INT[order(topTab_INT$adj.P.Val),]
kable(head(topTab_INT, 3), caption = 'Genes que modifican su expresión en función de la dieta administrada y de la cepas de rata (tabla ordenada según el p-valor ajustado)', digits = 5, row.names = TRUE)
```

Las tablas anteriores (Tablas 2, 3 y 4) muestran los genes que en el contraste de significancia presentan un p-valor ajustado menor para cada una de las comparaciones establecidas. La primera columna de estas tablas indica el código del gen de acuerdo con el distribuidor del microarray (Affimetrix en este caso). Destacamos dos aspectos de las tablas, en primer lugar, las tablas 2 y 3 presentan los mismo genes para el efecto de la dieta en cada una de las cepas, lo cual nos indica que estos genes son relevantes dado que se han expresado de forma diferencial en dos cepas distintas. En segundo lugar, vemos que la interacción entre cepa y dieta muestra p-valores ajustados muy altos, lo que nos llevará a eliminar esta comparación del resto del estudio, ya que no son significativos. 

## Anotación de los resultados

A partir de la base de datos de anotaciones correspondiente al microarray que se ha usado (_i.e._, `ragene10sttranscriptcluster.db`), podremos relacionar el código comercial de la primera columna con identificadores estándars de los nombres de los genes correspondientes (_i.e._, Gene Symbol or Entrez gene identifier).

```{r, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# Función para identificar los genes (Gene Annotation)
annotatedTopTable <- function(topTab, anotPackage)
{
  topTab <- cbind(PROBEID=rownames(topTab), topTab)
  myProbes <- rownames(topTab)
  thePackage <- eval(parse(text = anotPackage))
  geneAnots <- select(thePackage, myProbes, c("SYMBOL", "ENTREZID", "GENENAME"))
  annotatedTopTab<- merge(x=geneAnots, y=topTab, by.x="PROBEID", by.y="PROBEID")
  annotatedTopTab <- annotatedTopTab[order(annotatedTopTab$adj.P.Val),]
return(annotatedTopTab)
}
```

```{r, include=FALSE, echo=FALSE}
topAnnotated_STDvsCAF.LEW <- annotatedTopTable(topTab_STDvsCAF.LEW, anotPackage="ragene10sttranscriptcluster.db")
topAnnotated_STDvsCAF.WKY <- annotatedTopTable(topTab_STDvsCAF.WKY, anotPackage="ragene10sttranscriptcluster.db")
topAnnotated_INT <- annotatedTopTable(topTab_INT, anotPackage="ragene10sttranscriptcluster.db")
```

De modo que volvemos a mostrar las tablas anteriores, esta vez para los 10 primeros genes de cada comparación y añadiendo los códigos estándard:

 a) LEW.STD vs LEW.CAF: analizar el efecto de la dieta en la expresión génica para la cepa LEW

```{r, include=TRUE, echo=FALSE}
kable(head(topAnnotated_STDvsCAF.LEW,10), caption = 'Genes que modifican su expresión en función de la dieta administrada en la cepa de rata LEW (tabla ordenada según el p-valor ajustado)', digits = 30, row.names = FALSE)
```

  b) WKY.STD vs WKY.CAF: analizar el efecto de la dieta en la expresión génica para la cepa WKY
  
```{r, include=TRUE, echo=FALSE}
kable(head(topAnnotated_STDvsCAF.WKY, 10), caption = 'Genes que modifican su expresión en función de la dieta administrada en la cepa de rata WKY (tabla ordenada según el p-valor ajustado)', digits = 30, row.names = FALSE)
```

  c) INT: interacción entre la dieta administrada y la cepa de rata
  
```{r, include=TRUE, echo=FALSE}
kable(head(topAnnotated_INT, 10), caption = 'Genes que modifican su expresión en función de la dieta administrada y de la cepas de rata (tabla ordenada según el p-valor ajustado)', digits = 5, row.names = FALSE)
```

```{r, include=FALSE, echo=FALSE}
# Exportación de los genes ordenados por p-valor en función del contraste de cada comparación y con la anotación correspondiente
write.csv(topAnnotated_STDvsCAF.LEW, file= file.path(resultsDir, "topAnnotated_STDvsCAF.LEW.csv"))
write.csv(topAnnotated_STDvsCAF.WKY, file= file.path(resultsDir, "topAnnotated_STDvsCAF.WKY.csv"))
write.csv(topAnnotated_INT, file=file.path(resultsDir,"topAnnotated_INT.csv"))
```

## Comparación entre comparaciones

```{r,include=TRUE, echo=FALSE}
res <- decideTests(fit.main, method="separate", adjust.method="fdr", p.value=0.1, lfc=1)
sum.res.rows <- apply(abs(res),1,sum)
res.selected <- res[sum.res.rows!=0,] 
print(summary(res))
```

En la tabla se representan en las columnas el nº de comparaciones, mientras que las filas hacen referencia a la expresión genética, siendo _up-regulated_, _down-regulated_ o sin diferencia significativa estableciendo un cutoff de 0.1 del p-value y un log2-fold-change mínimo de 1. Aplicando este filtro obtenemos un conjunto de genes _down-regulated_ alto en los grupos STDvCAF para ambas cepas de rata, mientras que genes _up-regulated_ se encuentran la mitad o la tercera parte de los anteriores. Sin embargo, sorprenden los datos del grupo INT en los que no tenemos ningún gen significativo, es un dato que ya preveíamos de las tablas anteriores debido a los valores altos de p-valor ajustado. De modo que eliminiamos esta comparación del estudio. 

+ **Diagrama de Venn**

```{r, fig.width = 10, fig.asp = 1, fig.align="center", echo=FALSE, fig.cap="Genes en común entre las 3 comparaciones realizadas previamente (Selección FDR < 0.1 and logFC > 1)"}
vennDiagram (res.selected[,1:2], cex=0.9)
```

En el diagrama de Venn (ver Figura 11) representamos aquellos genes que se encuentran en común entre las 2 comparaciones anteriores de tipo de dieta administrada en función de la cepa de rata. En este caso, vemos que en la comparación de la dieta STDvsCAF para cada una de las cepas, comparten 140 genes _up_ o _down-regulated_ y que cada una de ellas presenta 29 y 67 genes que se expresan de forma diferenciada entre la cepa LEW y WKY, respectivamente.

+ **Heatmap**

```{r, echo=FALSE, include=TRUE, message=FALSE, warning=FALSE}
probesInHeatmap <- rownames(res.selected)
HMdata <- exprs(eset_filtered)[rownames(exprs(eset_filtered)) %in% probesInHeatmap,]
geneSymbols <- select(ragene10sttranscriptcluster.db, rownames(HMdata), c("SYMBOL"))
SYMBOLS<- geneSymbols$SYMBOL
rownames(HMdata) <- SYMBOLS
write.csv(HMdata, file = file.path(resultsDir, "data4Heatmap.csv"))
```

```{r, fig.width = 10, fig.asp = 1, fig.align="center", echo=FALSE, fig.cap="Heatmap de la expresión de genes agrupados por su similitud"}
my_palette <- colorRampPalette(c("blue", "red"))(n = 299)
heatmap(HMdata,
         Rowv = TRUE,
         Colv = TRUE,
         dendrogram = "both",
         main = "Differentially expressed genes \n FDR < 0,1, logFC >=1",
         scale = "row",
         col = my_palette,
         sepcolor = "white",
         sepwidth = c(0.05,0.05),
         cexRow = 0.5,
         cexCol = 0.9,
         key = TRUE,
         keysize = 1.5,
         density.info = "histogram",
         ColSideColors = c(rep("red",5),rep("blue",5), rep("green",5), rep("yellow",5)),
         tracecol = NULL,
         srtCol = 30)
```

En el heatmap (ver Figura 12) observamos los genes expresados significativamente destacados en una gradación de color (azul a rojo para _down-regulated_ y _up-regulated_, respectivamente). Los genes seleccionados según el criterio anterior (_i.e._, FDR < 0.1 and logFC > 1) se encuentran ordenados de acuerdo a su similitud.

## Análisis de significación biológica

Una vez obtenemos la lista de genes expresados diferencialmente entre dos condiciones, debemos interpretar su relevancia biológica, es decir, conocer en que rutas metabólicas están implicados para conocer su función. Este análisis lo realizamos con la ayuda del paquete `clusterProfiler`que nos permite conocer dichas rutas de acuerdo al `Entrez ID` de cada gen. 

En este caso, se recomienda según el protocolo de la asignatura [@microarrays], relajar los criterios de selección del p-valor y del fold change para seleccionar la lista de genes representativos. Sin embargo, dado que los p-valores ajustados son muy bajos, se ha establecido un _cutoff_ del p-valor ajustado < 0.1, obteniendo el siguiente número de genes significativos para cada comparación. 

```{r, echo=FALSE, include=TRUE}
listOfTables <- list(STDvsCAF.LEW = topAnnotated_STDvsCAF.LEW, 
                     STDvsCAF.WKY  = topAnnotated_STDvsCAF.WKY)
listOfSelected <- list()
for (i in 1:length(listOfTables)){
  # select the toptable
  topTab <- listOfTables[[i]]
  # select the genes to be included in the analysis
  whichGenes <- topTab$ENTREZID[topTab$adj.P.Val<0.1]
  # convert the ID to Entrez
  listOfSelected[[i]] <- whichGenes
  names(listOfSelected)[i] <- names(listOfTables)[i]
}
sapply(listOfSelected, length)
```

+ **Barplot para los términos EnrichGO**

```{r, fig.width = 10, fig.asp = 1, fig.align="center", echo=FALSE, fig.cap="Barplot para los términos de EnrichmentGO para el análisis el efecto de la dieta en la expresión génica para la cepa de rata LEWIS"}
genes_STDvsCAF.LEW <- listOfSelected[[1]]
edo_STDvsCAF.LEW <- enrichGO(genes_STDvsCAF.LEW, OrgDb = "org.Rn.eg.db", keyType = "ENTREZID")
barplot(edo_STDvsCAF.LEW, showCategory=40, main="Ratas LEWIS")
```

```{r, fig.width = 10, fig.asp = 1, fig.align="center", echo=FALSE, fig.cap="Barplot para los términos de EnrichmentGO para el análisis el efecto de la dieta en la expresión génica para la cepa de rata WISTAR KYOTO"}
genes_STDvsCAF.WKY <- listOfSelected[[2]]
edo_STDvsCAF.WKY <- enrichGO(genes_STDvsCAF.WKY, OrgDb = "org.Rn.eg.db", keyType = "ENTREZID")
barplot(edo_STDvsCAF.WKY, showCategory=40, main="Ratas WISTAR KYOTO")
```

En el barplot (ver Figura 13)  vemos que el 80% de los genes con p-valor significativo de la cepa LEW participan en la unión a fosfolípidos, así como un 65% aprox también se ve implicado en a la unión a carbohidratos y a diferentes nucleótidos y ribonucleótidos. La relación con los fosfolípidos y los carbohidratos podría estar justificada dada la relación de la dieta de cafetería que tiene como objetivo provocar síndrome metabólico y por lo tanto, provoca un aumento del número de lípidos. En el caso de las ratas WTY (ver Figura 14) también se visualiza la alta participación de los genes en la unión a fosfolípidos y carbohidratos, sin embargo no se ve una alta implicación en la unión a nucleótidos. Por el contrario, aparece una participación en la enzima hidrolasa ester-fosfórica y en la unión al fosfatidilinositol, otro tipo de lípido. 

+ **Gene-Concept Network**

```{r, fig.width = 10, fig.asp = 1, fig.align="center", echo=FALSE, fig.cap="Red para los términos de EnrichmentGO para el análisis el efecto de la dieta en la expresión génica para la cepa de rata LEW"}
edox <- setReadable(edo_STDvsCAF.LEW, 'org.Rn.eg.db', 'ENTREZID')
cnetplot(edox, node_label="all", showCategory = 4, colorEdge = TRUE, main="Ratas Lewis")
```


```{r, fig.width = 10, fig.asp = 1, fig.align="center", echo=FALSE, fig.cap="Red para los términos de EnrichmentGO para el análisis el efecto de la dieta en la expresión génica para la cepa de rata WKY"}
edox <- setReadable(edo_STDvsCAF.WKY, 'org.Rn.eg.db', 'ENTREZID')
cnetplot(edox, node_label="all", showCategory = 4, colorEdge = TRUE, main="Ratas WISTAR KYOTO")
```

Como hemos visto anteriormente, la red para agrupar los términos de Enrichment de los genes significativos (ver Figuras 15 y 16) tiene una alta participación en la unión a fosfolípidos para ambas cepas. Por otro lado, obtenemos otra red en la que se ven implicadas 3 dianas que participan en el sistema immune (_i.e._, CCR5, una proteína de membrana de la família GPCR y dos quimiocinas).
  
```{r, echo=FALSE, include=TRUE}
listOfFiles <- dir(resultsDir)
write.table(listOfFiles, file = "results_files.txt",  col.names = FALSE, row.names = FALSE)
```
  
```{r pagebreak, echo=FALSE, results='asis', eval=is_latex_output()}
cat('\\pagebreak')
```

# INFORME DEL ANÁLISIS

**Identificación de la expresión transcripcional en monocitos mediante el uso de modelos de ratas endogámicas en una dieta de cafetería**

## Abstract

La obesidad se ha convertido en una enfermedad de alta prevalencia a nivel mundial. El modelo animal nos permite estudiar esta enfermedad a diferentes niveles, por ello, se ha demostrado que una dieta alta en grasas y calorías reproduce los síntomas y factores propios de la obesidad en humanos. En este estudio se emplean dos cepas de rata (Wistar Kyoto (WKY) y Lewis (LEW) dado que presentan diferente respuesta a la dieta de cafetería alterando el transcriptoma de monocitos. Tras el análisis de la expresión de genes, se ha obtenido que hay una transcripción significativa de genes implicados en ruta metabólicas de unión a fosfolípidos y carbohidratos. Estos resultados reflejan la importancia de analizar el background genético como respuesta a diferentes ingestas nutricionales.

## Introducción y Objetivo

La obesidad representa un importante problema de salud con una alta tasa de crecimiento en nuestra sociedad. Por esta razón, es necesario disponer de modelos animales que reproduzcan de forma óptima las principales características de la obesidad humana (*i.e*., aumento de peso, adipogénesis y dislipidemia). Con este fin, en el presente estudio se emplean dos cepas de ratas que presentan dos perfiles genéticos que determinan una respuesta fenotípica y metabólica diferente tras la inducción producida por una dieta obesogénica. De modo que en el caso de las ratas Lewis (LEW) metabolizan preferentemente carbohidratos, mientras que las ratas Wistar Kyoto (WKY) metabolizan los lípidos y además, se observan variaciones en la regulación de la leptina @PMID-26450996. La dieta de cafetería (CAF) administrada a las ratas es considerada un buen modelo para provocar el síndrome metabólico y las patalogías relacionadas, entre las que se encuentran la obesidad. La dieta de cafetería consiste en la ingesta voluntaria de productos muy calóricos y energéticos.

Los monocitos son células immunitarias de particular interés dado que son circulantes se encuentran expuestas a factores metabólicos y la produccion de citoquinas pro-inflamatorias. En consecuencia, la regulación del perfil de expresión génica de monocitos podría reflejar el estado fisiológico de todo el organismo.

Por lo tanto, el análisis con microarrays en este estudio originalmente presenta dos objetivos:

  1) comparar los perfiles de expresión de monocitos entre las ratas WKY y LEW para identificar genes expresados por la adaptación genotípica inducida por la obesidad (dieta de cafetería).

  2) analizar el efecto de la dieta (STD vs cafetería) en la expresión genética de cada tipo de rata.
  
Sin embargo, en nuestro estudio nos hemos centrado en el análisis del segundo objetivo con el fin de simplificar y entender el análisis del microarray. 

## Materiales y Métodos

+ Diseño experimental 

Tras un periodo de adaptación cada cepa de rata fue distribuida de forma aleatoria a uno de los dos grupos de dieta administrada durante 7 semanas. La unidad observacional corresponde a los monocitos circulantes aislados de la extracción de sangre procedente de la aorta abdominal tras las 7 semanas de tratamiento.

+ Diseño computacional

El microarray empleado en este experimento es del tipo Rat Gene 1.0 ST arrays perteneciente a la casa comercial Affymetrix.
El análisis del microarray se ha analizado con la versión 3.6.1 de R (en el artículo se usa la versión 3.4.4) y empleando funciones y paquetes pertenecientes al proyecto Bioconductor. El dataset seleccionado se encuentra identificada con el ID de la base de datos _Gene Expression Omnibus_: `r params$GSE`. El dataset consta de dos factores con dos niveles cada una correspondientes a la cepa de rata (LEW y WKY) y la dieta administrada (STD y CAF). El número de muestras es de 20 repartidas en 4 grupos con 5 réplicas cada uno. 

## Resultados y Discusión

El análisis del microarray se ha llevado a cabo en primer lugar analizando la calidad de los datos. Como resultado se obtiene un potencial _outlier_ en la muestra WKY.CAF.5, pero tras la normalización se ha observado una mejora en la calidad de los datos. A continuación, se ha realizado un filtraje no específico para eliminar los genes que presentaban varianza aleatoria y no como consecuencia del tratamiento del estudio. De este filtro, obtenemos 4464 genes que potencialmente pueden ser significativos. Seguidamente, se ha realizado una matriz de contraste en la que se ha especificado que los grupos a comparar son en función del tipo de dieta para cada una de las cepas (STD vs CAF en LEW y WKY). Como resultado del test de significancia y aplicando cutoff para el fold change y el p-valor ajustado con el método Benjamini and Hochberg. Por último, se han analizado los términos de enrichment de GO database para agrupar los genes significativos en función de la ruta metabólica en la se ven implicada dichos genes. 

De acuerdo con los resultados publicados en el artículo orginal, se observó que la respuesta fenotípica en función de la dieta administrada en las ratas LEW resultaron significativas en la expresión de genes de monocitos, obteniendo 228 y 195 transcritos significativos up y down-regulated, respectivamente. Sin embargo, los términos de GO y KEGG no revelaron ningún enrequecimiento relativo a las rutas metabólicas relacionadas con la obesidad. En cambio, la modulación de la expresion de monocitos en ratas WKY obtuvo un cambio significativo obteniendo 483 y 449 transcritos up- y down-regulated. 

En nuestro caso, no se han obtenido los mismos valores de transcritos dado que hemos sido más restrictivos aplicando un cutoff de 0.1 del p-value y un log2-fold-change mínimo de 1, pero si que se obtiene que las ratas WKY presentan valores más elevados de transcripts significativos. 

No obstante, los genes significativos en cada cepa de rata no coinciden entre el estudio original y el realizado en el presente informe. Esto puede ser debido a múltiples factores como son el paquete empleado o el límite empleado para el p-valor y el fold-change. En todo caso, obtenemos que muchos de los genes siginificativos participan en el metabolismo de fosfolípidos y carbohidratos implicados activamente en la obesidad. También encontramos quimiocinas que participan en el sistema immune, lo cual es implicito en el hecho que estudiamos la expresión de monocitos. 
 
## Conclusión

Tras este informe, se ha conseguido analizar un microarray con el fin de valorar la respuesta fenotípica en dos cepas de rata a la dieta de cafetería. Se ha comprendido la importancia de cada paso del análisis y se han obtenido múltiples figuras que nos dan una imagen de la calidad de los datos, de la significancia de los test de comparación y de la participación de genes sigficativos en rutas metabólicas. No obstante, este primer paso de aproximación a un array se mejorará con el análisis de nuevas funciones y argumentos disponibles en Bioconductor. Así como también se requiere una mejor comprensión de toda la información extraída de cada gráfico y un análisis más detallado de cada uno de los genes significativos. 

## References


